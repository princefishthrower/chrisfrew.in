{"data":{"site":{"siteMetadata":{"title":"Chris Frewin's Full Stack Blog.","author":"Chris Frewin"}},"markdownRemark":{"id":"d175ef5c-8898-55c5-b689-87c09cb854b8","excerpt":"Node.js Server Monitor In  my attempt to automate my suite of websites , I wanted to build a simple Node.js server that monitors all my live…","html":"<h1>Node.js Server Monitor</h1>\n<p>In <a href=\"https://chrisfrew.in/fully-automating-chrisfrew-in-productions-part-1-of-roadmap-and-links-to-process/\">my attempt to automate my suite of websites</a>, I wanted to build a simple Node.js server that monitors all my live sites, and sends me an email. Basically the process is simply:</p>\n<ol>\n<li>‘cron’ job that every 30 seconds to ping all my websites</li>\n<li>Check for 200 response from each, if not send email</li>\n<li>If an even greater problem is found, i.e., the site doesn’t even return a 4** code, also send an email</li>\n<li>A ‘reactive’ monitor - that is, don’t just send a mail when there are problems, try to spool up the server again and log if there is a failure!</li>\n</ol>\n<p>To accomplish this I utilized just three Node.js libraries:</p>\n<ul>\n<li><code class=\"language-text\">http</code>, to request the various sites I control</li>\n<li><code class=\"language-text\">node-schedule</code>, to create a cron-like check</li>\n<li><code class=\"language-text\">nodemailer</code>, a fantastic easy-to-use bare bones emailer, we’ll send an email when there is a non 2** HTTP response or simple a non-response error (see code below) (<a href=\"https://medium.com/@manojsinghnegi/sending-an-email-using-nodemailer-gmail-7cfa0712a799\">there is a great medium post on an about 20ish liner in Node.js to get started</a>, and the setting in gmail you have to change)</li>\n</ul>\n<p>Obviously this can be developed into a much more complex monitor, but for now I am happy as to how it runs.</p>\n<h1>Improvements</h1>\n<p>A few things I would like to improve with this Server:</p>\n<ul>\n<li>Control the <code class=\"language-text\">const</code> array from somwehere else, perhaps a management GUI where I can maintain sites</li>\n<li>A global log class that could also be used in my Chrisfrew.in Productions Twitter Bot (coming soon in another post)</li>\n<li>Increasing the information and complexity of what is sent in the emails?</li>\n</ul>\n<h1>Code</h1>\n<p>As always, the most <a href=\"https://github.com/frewinchristopher/chrisfrew.in-productions-monitor\">up-to-date code will be on GitHub</a>, but as of this post, the full <code class=\"language-text\">index.js</code> code is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> schedule <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-schedule'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> nodemailer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nodemailer'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> aSitesToTrack <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"http://chrisfrew.in\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://nlp-champs.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://sirenapparel.us\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://chrisfrewin.design\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://seelengefluester-tirol.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"http://xn--seelengeflster-tirol-yec.com\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> transporter <span class=\"token operator\">=</span> nodemailer<span class=\"token punctuation\">.</span><span class=\"token function\">createTransport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n service<span class=\"token punctuation\">:</span> <span class=\"token string\">'gmail'</span><span class=\"token punctuation\">,</span>\n auth<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        user<span class=\"token punctuation\">:</span> <span class=\"token string\">'chrisfrew.in.productions@gmail.com'</span><span class=\"token punctuation\">,</span>\n        pass<span class=\"token punctuation\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">CHRISFREW_IN_PRODUCTIONS_GMAIL_PASSWORD</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> mailOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">from</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'chrisfrew.in.productions@gmail.com'</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// sender address</span>\n  to<span class=\"token punctuation\">:</span> <span class=\"token string\">'frewin.christopher@gmail.com'</span> <span class=\"token comment\">// list of receivers</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 1. cron this program every 30 seconds</span>\n<span class=\"token keyword\">var</span> j <span class=\"token operator\">=</span> schedule<span class=\"token punctuation\">.</span><span class=\"token function\">scheduleJob</span><span class=\"token punctuation\">(</span><span class=\"token string\">'30 * * * * *'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">pingSites</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 2. loop through all sites</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">pingSites</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  aSitesToTrack<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>sSite<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    http<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>sSite<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// make sure response is 200</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> statusCode <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span> <span class=\"token comment\">// destructure responsE integer</span>\n      <span class=\"token keyword\">const</span> sStatusCode <span class=\"token operator\">=</span> statusCode<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// convert to string</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>sStatusCode<span class=\"token punctuation\">.</span><span class=\"token function\">charAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"2\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// first digit should be a 2</span>\n        mailOptions<span class=\"token punctuation\">.</span>subject <span class=\"token operator\">=</span> <span class=\"token string\">'Site Monitor Chrisfrew.in Productions: Non 2** HTTP Status code'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Subject line</span>\n        mailOptions<span class=\"token punctuation\">.</span>html <span class=\"token operator\">=</span> <span class=\"token string\">\"The site &lt;b>\"</span> <span class=\"token operator\">+</span> sSite <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;/b> is returning a 404 HTTP error!\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// plain text body</span>\n        <span class=\"token function\">sendEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"404 email sent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// major error</span>\n      mailOptions<span class=\"token punctuation\">.</span>subject <span class=\"token operator\">=</span> <span class=\"token string\">'Site Monitor Chrisfrew.in Productions: Site non-responsive'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Subject line</span>\n      mailOptions<span class=\"token punctuation\">.</span>html <span class=\"token operator\">=</span> <span class=\"token string\">\"The site &lt;b>\"</span> <span class=\"token operator\">+</span> sSite <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;/b> is non responsive! (Not even a 404 response was found!)\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// plain text body</span>\n      <span class=\"token function\">sendEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Error email sent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Site ping of \"</span> <span class=\"token operator\">+</span> sSite <span class=\"token operator\">+</span> <span class=\"token string\">\" complete.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 3. send email if there was error</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">sendEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  transporter<span class=\"token punctuation\">.</span><span class=\"token function\">sendMail</span><span class=\"token punctuation\">(</span>mailOptions<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n         console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n       <span class=\"token keyword\">else</span>\n         console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Fully Automating Chrisfrew.in Productions - Part 2 of ??? - Building a Node.js Server Monitor","date":"May 11, 2018","draft":false,"starID":20,"postType":"dev"}}},"pageContext":{"slug":"/fully-automating-chrisfrew-in-productions-part-2-of-building-a-node-js-server-monitor/","prev":{"fields":{"slug":"/fully-automating-chrisfrew-in-productions-part-1-of-roadmap-and-links-to-process/"},"frontmatter":{"date":"10 May, 2018","title":"Fully Automating Chrisfrew.in Productions - Part 1 of ??? - Roadmap and Links to Entire Process","draft":false,"starID":19,"postType":"dev","link":"https://chrisfrew.in/fully-automating-chrisfrew-in-productions-part-1-of-roadmap-and-links-to-process/","relativeLink":"/fully-automating-chrisfrew-in-productions-part-1-of-roadmap-and-links-to-process/"}},"next":{"fields":{"slug":"/fully-automating-chrisfrew-in-productions-part-4-of-building-a-slack-bot/"},"frontmatter":{"date":"21 July, 2018","title":"Fully Automating Chrisfrew.in Productions - Part 4 of ??? - Building a Slack Bot","draft":false,"starID":23,"postType":"dev","link":"https://chrisfrew.in/fully-automating-chrisfrew-in-productions-part-4-of-building-a-slack-bot/","relativeLink":"/fully-automating-chrisfrew-in-productions-part-4-of-building-a-slack-bot/"}}}}