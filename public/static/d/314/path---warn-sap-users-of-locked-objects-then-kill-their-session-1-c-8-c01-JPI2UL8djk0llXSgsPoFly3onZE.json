{"data":{"site":{"siteMetadata":{"title":"Chris Frewin's Full Stack, Web Development, ABAP, SAPUI5, Blockchain, Machine Learning, & Natural Language Processing Blog.","author":"Chris Frewin"}},"markdownRemark":{"id":"/Users/chris/projects/chrisfrew.in/src/pages/warn-sap-users-of-locked-objects-then-kill-their-session/index.md absPath of file >>> MarkdownRemark","excerpt":"SAP users lockin‚Äô up your objects? We‚Äôre gonna write an ABAP report and run it as a batch job to ü§ñ  Automatically  ü§ñ get rid of them‚Ä¶","html":"<h2>SAP users lockin‚Äô up your objects?</h2>\n<h3>We‚Äôre gonna write an ABAP report and run it as a batch job to ü§ñ <em>Automatically</em> ü§ñ get rid of them!</h3>\n<h2>Overview</h2>\n<p>Alright everyone, we‚Äôre gonna walk through a fun ABAP report that involves functional programming, some challenging and creative BDC techniques, and a <em>‚Äòforbidden‚Äô SAP Kernel Call!!!</em> üò± üò± üò±</p>\n<h2>SAP and it‚Äôs Locked Objects</h2>\n<p>Anyone with a bit of technical sided SAP/ABAP experience knows that SAP has a locked object system - that is, a maximum of one entity can change an object at a time, wether it be a human user, a program, or any process. These ‚Äòobjects‚Äô in SAP are numerous - orders, HUs, even warehouse bins are ‚Äòobjects‚Äô that can be ‚Äòlocked‚Äô when they are under modification somewhere in the system.</p>\n<p>This can get very annoying when multiple entities want to change multiple objects in similar time frames.</p>\n<h2>A Remedy for the Problem</h2>\n<p>The ABAP report I‚Äôm going to go through alleviates this problem and could be useful for any company that has automatic processes applied to objects in the system, but at the same time have human users that <em>also</em> modify these objects.</p>\n<p>The example program I will go through is for orders specifically (think TYPE AUFNR). Feel free to modify the code for any locked objects of your liking üòä - the program logic following the locked object selection will not change, as we will soon see.</p>\n<h2>Specific Problem</h2>\n<p>At my company we had some batch jobs that were attempting to change orders, only to find that the users were locked by some of our employees in their own SAP GUI transactions. Nothing ‚Äòbad‚Äô per say was happening, we were just seeing in the protocol of those various batch jobs that the orders couldn‚Äôt be accessed. We realized a human user could easily forget they had a transaction open which locked an order, while they went off to work on something else, or were totally away from their work station.</p>\n<p>We decided ultimately to build a timed warning system for users that happened to be locking orders, functioning as follows:</p>\n<ol>\n<li>A warning popup for the user at 5 minutes of lock time</li>\n<li>A second warning popup for the user warning at 10 minutes of lock time</li>\n<li>Forcefully close the transaction that was locking the order at 15 minutes of lock time</li>\n</ol>\n<p>And yes, this can all be done from an automatic process with no overseeing required! üòä</p>\n<p>Let‚Äôs get started!</p>\n<h2>Identify Locked Objects</h2>\n<p>The first thing we need to do is get the locked objects and times of all those locked objects across the whole system. As I said, for this example case, we are only interested in locked <em>orders</em>. This is object type <code class=\"language-text\">AUFK</code> - the order head table. To get a list of all locked object across the system with this type, we can use function module <code class=\"language-text\">ENQUEUE_READ</code></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token eol-comment comment\">\" Get all AUFK table locks</span>\n<span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'ENQUEUE_READ'</span>\n  <span class=\"token keyword\">EXPORTING</span>\n    gname                 <span class=\"token operator\">=</span> <span class=\"token string\">'AUFK'</span>\n    guname                <span class=\"token operator\">=</span> <span class=\"token string\">'*'</span>              <span class=\"token eol-comment comment\">\" Users (all)</span>\n  <span class=\"token keyword\">TABLES</span>\n    enq                   <span class=\"token operator\">=</span> gt_enq\n  <span class=\"token keyword\">EXCEPTIONS</span>\n    communication_failure <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    system_failure        <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n    <span class=\"token keyword\">OTHERS</span>                <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>So, by now we have our table of objects, and the users who are locking them. We will also need all the sessions open across the system. We can get that with the nice SAP Standard class <code class=\"language-text\">cl_server_info</code> (pretty obvious name, eh? üòÇ). </p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token eol-comment comment\">\" Get all user sessions</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">OBJECT</span> server_info<span class=\"token punctuation\">.</span>\ngt_session_list <span class=\"token operator\">=</span> server_info<span class=\"token token-operator punctuation\">-></span>get_session_list<span class=\"token punctuation\">(</span> with_application_info <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>However, we can‚Äôt just kill all of a user‚Äôs sessions - we only want to shut down (indeed, this is bad luck for the user that has only one SAP application window open that is blocking an order, but hey, they get two warnings before we shut them down)</p>\n<h2>The ‚ÄòForbidden‚Äô Kernel Call</h2>\n<p>To get the fidelity needed to find exactly which index of SAP application window, we‚Äôre gonna have go down the system rabbithole and use a f (remember, it is always 1-7 ‚Äî> the classic SAP limit of 7 open windows per client)</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token keyword\">CALL</span> <span class=\"token string\">'ThUsrInfo'</span> <span class=\"token keyword\">ID</span> <span class=\"token string\">'OPCODE'</span> <span class=\"token keyword\">FIELD</span> opcode_usr_info\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'TID'</span> <span class=\"token keyword\">FIELD</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>logon_hdl\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'WITH_APPL_INFO'</span> <span class=\"token keyword\">FIELD</span> with_appl_info\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'TABLE'</span> <span class=\"token keyword\">FIELD</span> gt_usr_info[]<span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>What this kernel call retrieves and puts in table <code class=\"language-text\">gt_user_info</code> can be also found be found through the standard SAP GUI in transaction <code class=\"language-text\">SM04</code> by selecting a session and going to the top menu bar and selecting User->Technical Information):</p>\n<p><img src=\"technical-information.png\" alt=\"How to navigate to technical information in SAP GUI transaction SM04\"></p>\n<p>You will see a giant list of multiple fields for each session number (0-6) that the user has open. So, what can we do with this giant technical information list of key value pairs? </p>\n<p>In SAP, this works as follows: each <em>login</em> by a user (not session number, we‚Äôre not there yet üòÑ)  is assigned a unique login ID which is generated based on things you log in with: the client number, system, and language. This session ID has the form of <code class=\"language-text\">TXX_UXXXXX</code>, where <code class=\"language-text\">X</code> can be any number 0-9. </p>\n<p>Each session then has a session ID which is comprised of first the login ID as described above, with an appended <code class=\"language-text\">_MX</code>, where <code class=\"language-text\">X</code> in this case is the session number, 0-6 (session 1-7). So, we are interested in the <code class=\"language-text\">.session</code> value of this technical list:</p>\n<p><img src=\"session-id.png\" alt=\"Session ID in the technical information.\"></p>\n<p>You can notice then that session 2 would have </p>\n<p><code class=\"language-text\">modeinfo[1].session = T23_U31974_M1</code> </p>\n<p>session 3 would have</p>\n<p><code class=\"language-text\">modeinfo[2].session = T23_U31974_M2</code> </p>\n<p>and so on, all the way up to session 7 - or index 6. We will see in the code that I leverage this pattern. The only way to find the true session that is blocking the order is to first guess the logon instance for the user (in the case for example that htey have logged on with multiple languages), then you can back out all the session ID‚Äôs until you get a match of the <code class=\"language-text\">session_hdl</code> from the returned list of <code class=\"language-text\">gt_sessions_list</code>.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token keyword\">CLEAR</span> gt_sessions_user<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_session_list <span class=\"token keyword\">INTO</span> gs_session_list <span class=\"token keyword\">WHERE</span> tenant <span class=\"token keyword\">EQ</span> sy<span class=\"token token-operator punctuation\">-</span>mandt<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" loop at all open sessions to build a list of just the user sessions</span>\n\n  <span class=\"token eol-comment comment\">\" if a user is not in the given so, we continue (that means with exclude users, they are skipped, those with equals and all others keep going)</span>\n  <span class=\"token keyword\">IF</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>user_name <span class=\"token keyword\">NOT</span> <span class=\"token keyword\">IN</span> so_bname<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n  gv_user_name   <span class=\"token operator\">=</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>user_name<span class=\"token punctuation\">.</span>\n\n  <span class=\"token eol-comment comment\">\" Only add to list if user is current lock user - also get the session id for this user</span>\n  <span class=\"token keyword\">IF</span> gv_user_name <span class=\"token keyword\">EQ</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CLEAR</span> gv_modus_index<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CLEAR</span> gt_usr_info[]<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CLEAR</span> gs_usr_info<span class=\"token punctuation\">.</span>\n    <span class=\"token eol-comment comment\">\" get detailed technical info for this user to find which specific session to close</span>\n    <span class=\"token keyword\">CALL</span> <span class=\"token string\">'ThUsrInfo'</span> <span class=\"token keyword\">ID</span> <span class=\"token string\">'OPCODE'</span> <span class=\"token keyword\">FIELD</span> opcode_usr_info\n      <span class=\"token keyword\">ID</span> <span class=\"token string\">'TID'</span> <span class=\"token keyword\">FIELD</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>logon_hdl\n      <span class=\"token keyword\">ID</span> <span class=\"token string\">'WITH_APPL_INFO'</span> <span class=\"token keyword\">FIELD</span> with_appl_info\n      <span class=\"token keyword\">ID</span> <span class=\"token string\">'TABLE'</span> <span class=\"token keyword\">FIELD</span> gt_usr_info[]<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CONCATENATE</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gusrvb <span class=\"token string\">'/UPD'</span> <span class=\"token keyword\">INTO</span> gv_value<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" We need to use the </span><span class=\"token string\">'/UPD'</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">in</span> the technical info <span class=\"token keyword\">to</span> <span class=\"token keyword\">get</span> the <span class=\"token keyword\">exact</span> session <span class=\"token keyword\">assigned</span> <span class=\"token keyword\">to</span> the specific locked <span class=\"token keyword\">object</span>\n    <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_usr_info <span class=\"token keyword\">INTO</span> gs_usr_info <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">EQ</span> gv_value<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" find the field from the value</span>\n      gv_modus_index <span class=\"token operator\">=</span> gs_usr_info<span class=\"token token-operator punctuation\">-</span>field+<span class=\"token number\">9</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" the key for the value is </span><span class=\"token string\">'modeinfo[X].enq_info'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> we need just the <span class=\"token keyword\">X</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> so we +<span class=\"token number\">9</span> <span class=\"token keyword\">then</span> take the <span class=\"token keyword\">single</span> <span class=\"token keyword\">character</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n    <span class=\"token eol-comment comment\">\" If we found a session with that number, we know we had the correct logon... we can add this to the user list</span>\n    <span class=\"token keyword\">IF</span> gv_modus_index <span class=\"token keyword\">IS</span> <span class=\"token keyword\">NOT</span> <span class=\"token keyword\">INITIAL</span><span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" convert to type ssi_session_handle for later lookup</span>\n      gv_modus_num_found <span class=\"token operator\">=</span> gv_modus_index<span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" get the session id for this specific</span>\n      <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'modeinfo['</span> gv_modus_index <span class=\"token string\">'].session'</span> <span class=\"token keyword\">INTO</span> gv_field<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" this time we need to find the value from the field</span>\n      <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_usr_info <span class=\"token keyword\">INTO</span> gs_usr_info <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">field</span> <span class=\"token keyword\">EQ</span> gv_field<span class=\"token punctuation\">.</span>\n        gv_ssi_session_id <span class=\"token operator\">=</span> gs_usr_info<span class=\"token token-operator punctuation\">-</span>value<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">APPEND</span> gs_session_list <span class=\"token keyword\">TO</span> gt_sessions_user<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>Here - as will make more sense in the full code - I am building a <code class=\"language-text\">gt_sessions_user</code> list on the fly, which is what is passed to a BDC method to close that specific session ID for that user alone (explained below). I decided to run the program with this one-user-at-a-time method in order to have the minimum amount of time between finding a session that was locking an object and messaging / deleting that session. </p>\n<p>If we had say, 1000 locked orders on our system, and I built an entire list of all blocking sessions across all users, it could be the case that by the time we get to the BDC method (which, by the way, is slow itself, especially when you need it to be synchronous as we need in this process), the user could have already closed that blocking session, or worse, switched to a transaction in that session number which was no longer blocking the order! In such a case we would be unnecessarily sending warning messages or closing the transaction to a session which didn‚Äôt apply anymore! Bad.</p>\n<p>So - we‚Äôve pinpointed the exact user and their session number that is blocking the order - let‚Äôs send them our warning messages at 5 and 10 minutes.</p>\n<h2>No Way! A <em>SECOND</em> ‚ÄòForbidden‚Äô Module?!</h2>\n<p>To send a popup message to a user, we need to now make use of <em>second</em> <code class=\"language-text\">TH*</code> function, <code class=\"language-text\">TH_POPUP</code> (though at least this time it is at least a SAP function, and not a sneaky system function):</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'You are locking'</span> gv_aufnr_string <span class=\"token string\">'in TC'</span> gv_tcode <span class=\"token string\">' for >5min. Please save and leave the transaction.'</span> <span class=\"token keyword\">INTO</span> gv_message <span class=\"token keyword\">SEPARATED</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">space</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'TH_POPUP'</span>\n      <span class=\"token keyword\">EXPORTING</span>\n        <span class=\"token keyword\">client</span>         <span class=\"token operator\">=</span> sy<span class=\"token token-operator punctuation\">-</span>mandt\n        <span class=\"token keyword\">user</span>           <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname\n        <span class=\"token keyword\">message</span>        <span class=\"token operator\">=</span> gv_message\n      <span class=\"token keyword\">EXCEPTIONS</span>\n        user_not_found <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">OTHERS</span>         <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>This function module actually heads to the kernel as well, because the user won‚Äôt get a popup directly in the SAP GUI, but rather a warning message directly in the their operating system. It looks like this when testing from <code class=\"language-text\">SE37</code>:</p>\n<p><img src=\"TH_POPUP-function-test.png\" alt=\"Testing TH_POPUP in transaction SE37.\"></p>\n<p>And our resulting system popup (at least how it looks on windows operating system)</p>\n<p><img src=\"TH_POPUP-result.png\" alt=\"What a successful call of TH_POPUP from SE37 looks like.\"></p>\n<p>Ok, so we‚Äôve warned the users twice by now with our popup, but they still are blocking a dang order! Remember, each run we‚Äôve still got their exact session number that is blocking the order, so let‚Äôs finally go in for the kill and shut down that session! Once we do that, we log which session/user/transaction combo we deleted to the spool, and this report is done!</p>\n<h2>BDC Tricks To Finally Close The User Session</h2>\n<p>I searched and searched, but there seems to be no function module that can explicitely close a specific user session - there‚Äôs probably good reason for this! (Though I can‚Äôt <em>possibly</em> think of why ü§î üòâ) </p>\n<p>I couldn‚Äôt even find another ‚Äòforbidden‚Äô <code class=\"language-text\">Th****</code> function module that can do this. However, this <em>is</em> possible through the standard SAP GUI, and we‚Äôve already mentioned it in this post, our friend transaction <code class=\"language-text\">SM04</code>. By double clicking on a user (using me for an example), we get a list like this (sorry for the black boxes - don‚Äôt want to inadvertantly reveal anything that may be proprietary):</p>\n<p><img src=\"server-sessions-list.png\" alt=\"List of user sessions on the server.\"></p>\n<p>Then you need only select the desired session number and click ‚ÄúDelete Session‚Äù, then ‚òÅPOOF!‚òÅ that user‚Äôs session will be gone!</p>\n<p><img src=\"delete-session.png\" alt=\"Deleting a user session by session number.\"></p>\n<p>Thank me later, but in BDC form, this can be written as follows:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token eol-comment comment\">\" First ensure that sm04 is called and set to the sessions view</span>\n      <span class=\"token keyword\">CLEAR</span> bdcdata[]<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=SESSIONS'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" call transaction SM04, sync (S), no screens unless debugger (P)</span>\n      <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token string\">'SM04'</span>\n              <span class=\"token keyword\">USING</span> bdcdata\n              <span class=\"token keyword\">MODE</span> <span class=\"token string\">'P'</span>\n              <span class=\"token keyword\">UPDATE</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">.</span>\n\n      <span class=\"token eol-comment comment\">\" Now use bdc to end the session with that session id</span>\n      <span class=\"token keyword\">CLEAR</span> bdcdata[]<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;OL0'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSKBH'</span> <span class=\"token string\">'0800'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'GT_FIELD_LIST-SELTEXT(01)'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=WLSE'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'GT_FIELD_LIST-MARK(01)'</span> <span class=\"token string\">'X'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSKBH                                0810SUB810'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSKBH'</span> <span class=\"token string\">'0800'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'GT_FIELD_LIST-SELTEXT(01)'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=CONT'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSKBH                                0810SUB810'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=PS 63'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'02/76'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;IC1'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'02/76'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;ILT'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSSEL'</span> <span class=\"token string\">'1104'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=CRET'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSSEL                                1105%_SUBSCREEN_FREESEL'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'%%DYN001-LOW'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'%%DYN001-LOW'</span> gv_ssi_session_id<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/15'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;IC1'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'RSM04000_ALV_NEW'</span> <span class=\"token string\">'2000'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> gv_modus_string<span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=DEL'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/15'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;F15'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" call transaction SM04, sync (S), no screens unless debugger (P)</span>\n      <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token string\">'SM04'</span>\n              <span class=\"token keyword\">USING</span> bdcdata\n              <span class=\"token keyword\">MODE</span> <span class=\"token string\">'P'</span>\n              <span class=\"token keyword\">UPDATE</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">.</span></code></pre>\n      </div>\n<p>If you stick around the blog and or read other ABAP BDC posts of mine, you‚Äôll see for BDC I always use the following helper form <code class=\"language-text\">bdcdaten</code> that allows me to write the BDC so cleanly (as it is above):</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token comment\">*&amp;      Form  BDCDATEN</span>\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token keyword\">FORM</span> bdcdaten <span class=\"token keyword\">USING</span> start fnam fval<span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">CLEAR</span> bdcdata<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">IF</span> start <span class=\"token operator\">=</span> <span class=\"token string\">'X'</span><span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>dynbegin <span class=\"token operator\">=</span> start<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>program  <span class=\"token operator\">=</span> fnam<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>dynpro   <span class=\"token operator\">=</span> fval<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ELSE</span><span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>fnam <span class=\"token operator\">=</span> fnam<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>fval <span class=\"token operator\">=</span> fval<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">APPEND</span> bdcdata<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">ENDFORM</span><span class=\"token punctuation\">.</span>                               <span class=\"token eol-comment comment\">\" BDCDATEN</span></code></pre>\n      </div>\n<p>The only thing worth noting here is in our first step we always ensure the server view of <code class=\"language-text\">SM04</code> is active - we need to always run in server view, because we don‚Äôt want all sessions across all servers. In this way, this report can run in parallel on all your servers and concern it self only with users logged on to the server instance that this report is running on. This will make the run time a bit faster, and of course splits up the search work across all servers.</p>\n<h1>Full Code</h1>\n<p>The full code of the report is as follows:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-abap\"><code class=\"language-abap\"><span class=\"token keyword\">REPORT</span> z_user_session_kill<span class=\"token punctuation\">.</span>\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token comment\">*&amp; Report: Z_USER_SESSION_KILL                                         *</span>\n<span class=\"token comment\">*&amp; Author: Christopher Frewin                                          *</span>\n<span class=\"token comment\">*&amp; Creation Date: 2018.05.09                                           *</span>\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token comment\">*&amp;                                                                     *</span>\n<span class=\"token comment\">*&amp;                                                                     *</span>\n<span class=\"token comment\">*&amp;                                                         __          *</span>\n<span class=\"token comment\">*&amp;                                           Christophe_r_|  |_F_rewin *</span>\n<span class=\"token comment\">*&amp;                                                     |__    __|      *</span>\n<span class=\"token comment\">*&amp;                                                        |  |         *</span>\n<span class=\"token comment\">*&amp;                                \"Z_USER_SESSION_KILL\"   |  |         *</span>\n<span class=\"token comment\">*&amp;                                                        |__|  17'    *</span>\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n\n<span class=\"token eol-comment comment\">\" table needed for FOR in select-options statement</span>\n<span class=\"token keyword\">TABLES</span><span class=\"token punctuation\">:</span> usr02<span class=\"token punctuation\">.</span>\n\n<span class=\"token eol-comment comment\">\" Data...  :)</span>\n<span class=\"token keyword\">DATA</span><span class=\"token punctuation\">:</span> gv_time_dif_sperr   <span class=\"token keyword\">TYPE</span> tims<span class=\"token punctuation\">,</span>\n      gv_tcode            <span class=\"token keyword\">TYPE</span> eqetcode<span class=\"token punctuation\">,</span>\n      gv_aufnr            <span class=\"token keyword\">TYPE</span> aufnr<span class=\"token punctuation\">,</span>\n      gv_message          <span class=\"token keyword\">TYPE</span> sm04dic<span class=\"token token-operator punctuation\">-</span>popupmsg<span class=\"token punctuation\">,</span>\n      gv_objnr            <span class=\"token keyword\">TYPE</span> j_objnr<span class=\"token punctuation\">,</span>\n      gv_stat             <span class=\"token keyword\">TYPE</span> j_status<span class=\"token punctuation\">,</span>\n      gt_enq              <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">OF</span> seqg3<span class=\"token punctuation\">,</span>\n      gs_enq              <span class=\"token keyword\">LIKE</span> <span class=\"token keyword\">LINE</span> <span class=\"token keyword\">OF</span> gt_enq<span class=\"token punctuation\">,</span>\n      server_info         <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">REF</span> <span class=\"token keyword\">TO</span> cl_server_info<span class=\"token punctuation\">,</span>\n      gt_session_list     <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">OF</span> ssi_session_info<span class=\"token punctuation\">,</span>\n      gs_session_list     <span class=\"token keyword\">LIKE</span> <span class=\"token keyword\">LINE</span> <span class=\"token keyword\">OF</span> gt_session_list<span class=\"token punctuation\">,</span>\n      gt_sessions_user    <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token keyword\">OF</span> ssi_session_info<span class=\"token punctuation\">,</span>\n      gs_sessions_user    <span class=\"token keyword\">LIKE</span> <span class=\"token keyword\">LINE</span> <span class=\"token keyword\">OF</span> gt_sessions_user<span class=\"token punctuation\">,</span>\n      bdcdata             <span class=\"token keyword\">LIKE</span> bdcdata <span class=\"token keyword\">OCCURS</span> <span class=\"token number\">0</span> <span class=\"token keyword\">WITH</span> <span class=\"token keyword\">HEADER</span> <span class=\"token keyword\">LINE</span><span class=\"token punctuation\">,</span>\n      gv_modus_string     <span class=\"token keyword\">TYPE</span> string<span class=\"token punctuation\">,</span>\n      gv_modus_index      <span class=\"token keyword\">TYPE</span> string<span class=\"token punctuation\">,</span>\n      gv_user_name        <span class=\"token keyword\">TYPE</span> eqeuname<span class=\"token punctuation\">,</span>\n      th_opcode<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>        <span class=\"token keyword\">TYPE</span> <span class=\"token keyword\">x</span><span class=\"token punctuation\">,</span>\n      with_appl_info      <span class=\"token keyword\">TYPE</span> ssi_bool <span class=\"token keyword\">VALUE</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n      gv_field<span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      gv_value<span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      gv_ssi_session_id   <span class=\"token keyword\">TYPE</span> ssi_session_id<span class=\"token punctuation\">,</span>\n      gv_modus_num        <span class=\"token keyword\">TYPE</span> ssi_session_hdl<span class=\"token punctuation\">,</span>\n      gv_modus_num_found  <span class=\"token keyword\">TYPE</span> ssi_session_hdl<span class=\"token punctuation\">,</span>\n      gv_modus_index_char <span class=\"token keyword\">TYPE</span> numc1<span class=\"token punctuation\">,</span>\n      gv_aufnr_string     <span class=\"token keyword\">TYPE</span> string<span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">BEGIN</span> <span class=\"token keyword\">OF</span> gt_usr_info <span class=\"token keyword\">OCCURS</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">field</span><span class=\"token punctuation\">(</span><span class=\"token number\">40</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">VALUE</span><span class=\"token punctuation\">(</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token keyword\">END</span> <span class=\"token keyword\">OF</span> gt_usr_info<span class=\"token punctuation\">,</span>\n      gs_usr_info <span class=\"token keyword\">LIKE</span> <span class=\"token keyword\">LINE</span> <span class=\"token keyword\">OF</span> gt_usr_info<span class=\"token punctuation\">,</span>\n      gv_autyp    <span class=\"token keyword\">TYPE</span> auftyp<span class=\"token punctuation\">,</span>\n      gv_uzeit    <span class=\"token keyword\">TYPE</span> sy<span class=\"token token-operator punctuation\">-</span>uzeit<span class=\"token punctuation\">,</span>\n      gv_string   <span class=\"token keyword\">TYPE</span> string<span class=\"token punctuation\">.</span>\n\n<span class=\"token eol-comment comment\">\" select option to exlude user</span>\n<span class=\"token keyword\">SELECT-OPTIONS</span><span class=\"token punctuation\">:</span> so_bname <span class=\"token keyword\">FOR</span> usr02<span class=\"token token-operator punctuation\">-</span>bname <span class=\"token keyword\">MEMORY</span> <span class=\"token keyword\">ID</span> xus <span class=\"token keyword\">NO</span> <span class=\"token keyword\">INTERVALS</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">CONSTANTS</span><span class=\"token punctuation\">:</span> opcode_usr_info <span class=\"token keyword\">LIKE</span> th_opcode <span class=\"token keyword\">VALUE</span> <span class=\"token number\">52</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" this is the internal SAP number used for the system function module </span><span class=\"token string\">'ThUsrInfo'</span>\ngv_uzeit <span class=\"token operator\">=</span> sy<span class=\"token token-operator punctuation\">-</span>uzeit<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" moved up here to have time before the enqueue_read function</span>\n\n<span class=\"token eol-comment comment\">\" Get all AUFK table locks</span>\n<span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'ENQUEUE_READ'</span>\n  <span class=\"token keyword\">EXPORTING</span>\n    gname                 <span class=\"token operator\">=</span> <span class=\"token string\">'AUFK'</span>\n    guname                <span class=\"token operator\">=</span> <span class=\"token string\">'*'</span>              <span class=\"token eol-comment comment\">\" Users (all)</span>\n  <span class=\"token keyword\">TABLES</span>\n    enq                   <span class=\"token operator\">=</span> gt_enq\n  <span class=\"token keyword\">EXCEPTIONS</span>\n    communication_failure <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n    system_failure        <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n    <span class=\"token keyword\">OTHERS</span>                <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">IF</span> sy<span class=\"token token-operator punctuation\">-</span>subrc <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">EXIT</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token eol-comment comment\">\" Get all user sessions</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">OBJECT</span> server_info<span class=\"token punctuation\">.</span>\ngt_session_list <span class=\"token operator\">=</span> server_info<span class=\"token token-operator punctuation\">-></span>get_session_list<span class=\"token punctuation\">(</span> with_application_info <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token eol-comment comment\">\" Loop through each locked object (production orders)</span>\n<span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_enq <span class=\"token keyword\">INTO</span> gs_enq<span class=\"token punctuation\">.</span>\n\n  <span class=\"token eol-comment comment\">\" Auftrag and Tcode for nice printing in the messages</span>\n  gv_tcode <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gtcode<span class=\"token punctuation\">.</span>\n  gv_aufnr_string <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>garg+<span class=\"token number\">3</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">SHIFT</span> gv_aufnr_string <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">DELETING</span> <span class=\"token keyword\">LEADING</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">CONDENSE</span> gv_tcode<span class=\"token punctuation\">.</span>\n\n  <span class=\"token eol-comment comment\">\" We keep only the orders that have the status FREI ---> stat </span><span class=\"token string\">'I0002'</span> <span class=\"token keyword\">in</span> <span class=\"token keyword\">table</span> JEST\n  gv_aufnr <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>garg+<span class=\"token number\">3</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" GARG for aufnr is in the format </span><span class=\"token string\">'10000000XXXXXXX'</span> therefore <span class=\"token keyword\">with</span> +<span class=\"token number\">3</span> we should have the <span class=\"token keyword\">standard</span> aufnr <span class=\"token keyword\">format</span> 00000XXXXXXX <span class=\"token punctuation\">(</span><span class=\"token number\">12</span> CHAR <span class=\"token keyword\">long</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token eol-comment comment\">\" Only orders with type 10 or 40 (production and proess orders)</span>\n  <span class=\"token keyword\">CLEAR</span> gv_autyp<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">SINGLE</span> autyp <span class=\"token keyword\">FROM</span> aufk <span class=\"token keyword\">INTO</span> gv_autyp\n    <span class=\"token keyword\">WHERE</span> aufnr <span class=\"token keyword\">EQ</span> gv_aufnr<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">IF</span> gv_autyp <span class=\"token keyword\">NE</span> <span class=\"token string\">'10'</span> <span class=\"token keyword\">AND</span> gv_autyp <span class=\"token keyword\">NE</span> <span class=\"token string\">'40'</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">DELETE</span> gt_enq <span class=\"token keyword\">INDEX</span> sy<span class=\"token token-operator punctuation\">-</span>tabix<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" delete this line</span>\n    <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" and go on to the next lock object in gt_enq</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token eol-comment comment\">\" Also check JEST table - first format to OR0000XXXXXXX form</span>\n  <span class=\"token keyword\">CLEAR</span> gv_objnr<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'OR'</span> gv_aufnr <span class=\"token keyword\">INTO</span> gv_objnr<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">SINGLE</span> stat <span class=\"token keyword\">FROM</span> jest <span class=\"token keyword\">INTO</span> gv_stat\n    <span class=\"token keyword\">WHERE</span> objnr <span class=\"token keyword\">EQ</span> gv_objnr\n    <span class=\"token keyword\">AND</span>   stat  <span class=\"token keyword\">EQ</span> <span class=\"token string\">'I0002'</span>\n    <span class=\"token keyword\">AND</span>   inact <span class=\"token keyword\">EQ</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">IF</span> sy<span class=\"token token-operator punctuation\">-</span>subrc <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" FREI status not found, delete the entry</span>\n    <span class=\"token keyword\">DELETE</span> gt_enq <span class=\"token keyword\">INDEX</span> sy<span class=\"token token-operator punctuation\">-</span>tabix<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" delete this line</span>\n    <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" and go on to the next lock object in gt_enq</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n  <span class=\"token eol-comment comment\">\" Determine how long object has been locked</span>\n  <span class=\"token keyword\">IF</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gttime <span class=\"token keyword\">GT</span> gv_uzeit<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" check to make sure the current time is at least as big as the lock time - otherwise we get giant times 23:59:59 when subtracting</span>\n    <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" if this is the case, go to the next locked object</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  gv_time_dif_sperr <span class=\"token operator\">=</span> gv_uzeit <span class=\"token operator\">-</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gttime<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" locked object time calculation itself is simple, difference of current time and time when it was first locked</span>\n\n  <span class=\"token eol-comment comment\">\" Finally take action depending on the time 15 minute most sever, 10 minute strong warning, 5 minute weak warning.</span>\n  <span class=\"token keyword\">IF</span> gv_time_dif_sperr <span class=\"token operator\">></span> <span class=\"token string\">'001500'</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" kill the user sessions after 15 minutes - will kill those that are in the transaction of the locked object</span>\n\n    <span class=\"token keyword\">CLEAR</span> gt_sessions_user<span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_session_list <span class=\"token keyword\">INTO</span> gs_session_list <span class=\"token keyword\">WHERE</span> tenant <span class=\"token keyword\">EQ</span> sy<span class=\"token token-operator punctuation\">-</span>mandt<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" loop at all open sessions to build a list of just the user sessions</span>\n\n      <span class=\"token eol-comment comment\">\" if a user is not in the given so, we continue (that means with exclude users, they are skipped, those with equals and all others keep going)</span>\n      <span class=\"token keyword\">IF</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>user_name <span class=\"token keyword\">NOT</span> <span class=\"token keyword\">IN</span> so_bname<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n      gv_user_name   <span class=\"token operator\">=</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>user_name<span class=\"token punctuation\">.</span>\n\n      <span class=\"token eol-comment comment\">\" Only add to list if user is current lock user - also get the session id for this user</span>\n      <span class=\"token keyword\">IF</span> gv_user_name <span class=\"token keyword\">EQ</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">CLEAR</span> gv_modus_index<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">CLEAR</span> gt_usr_info[]<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">CLEAR</span> gs_usr_info<span class=\"token punctuation\">.</span>\n        <span class=\"token eol-comment comment\">\" get detailed technical info for this user to find which specific session to close</span>\n        <span class=\"token keyword\">CALL</span> <span class=\"token string\">'ThUsrInfo'</span> <span class=\"token keyword\">ID</span> <span class=\"token string\">'OPCODE'</span> <span class=\"token keyword\">FIELD</span> opcode_usr_info\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'TID'</span> <span class=\"token keyword\">FIELD</span> gs_session_list<span class=\"token token-operator punctuation\">-</span>logon_hdl\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'WITH_APPL_INFO'</span> <span class=\"token keyword\">FIELD</span> with_appl_info\n          <span class=\"token keyword\">ID</span> <span class=\"token string\">'TABLE'</span> <span class=\"token keyword\">FIELD</span> gt_usr_info[]<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">CONCATENATE</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gusrvb <span class=\"token string\">'/UPD'</span> <span class=\"token keyword\">INTO</span> gv_value<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" We need to use the </span><span class=\"token string\">'/UPD'</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">in</span> the technical info <span class=\"token keyword\">to</span> <span class=\"token keyword\">get</span> the <span class=\"token keyword\">exact</span> session <span class=\"token keyword\">assigned</span> <span class=\"token keyword\">to</span> the specific locked <span class=\"token keyword\">object</span>\n        <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_usr_info <span class=\"token keyword\">INTO</span> gs_usr_info <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">value</span> <span class=\"token keyword\">EQ</span> gv_value<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" find the field from the value</span>\n          gv_modus_index <span class=\"token operator\">=</span> gs_usr_info<span class=\"token token-operator punctuation\">-</span>field+<span class=\"token number\">9</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" the key for the value is </span><span class=\"token string\">'modeinfo[X].enq_info'</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> we need just the <span class=\"token keyword\">X</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> so we +<span class=\"token number\">9</span> <span class=\"token keyword\">then</span> take the <span class=\"token keyword\">single</span> <span class=\"token keyword\">character</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n        <span class=\"token eol-comment comment\">\" If we found a session with that number, we know we had the correct logon... we can add this to the user list</span>\n        <span class=\"token keyword\">IF</span> gv_modus_index <span class=\"token keyword\">IS</span> <span class=\"token keyword\">NOT</span> <span class=\"token keyword\">INITIAL</span><span class=\"token punctuation\">.</span>\n          <span class=\"token eol-comment comment\">\" convert to type ssi_session_handle for later lookup</span>\n          gv_modus_num_found <span class=\"token operator\">=</span> gv_modus_index<span class=\"token punctuation\">.</span>\n          <span class=\"token eol-comment comment\">\" get the session id for this specific</span>\n          <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'modeinfo['</span> gv_modus_index <span class=\"token string\">'].session'</span> <span class=\"token keyword\">INTO</span> gv_field<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" this time we need to find the value from the field</span>\n          <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_usr_info <span class=\"token keyword\">INTO</span> gs_usr_info <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">field</span> <span class=\"token keyword\">EQ</span> gv_field<span class=\"token punctuation\">.</span>\n            gv_ssi_session_id <span class=\"token operator\">=</span> gs_usr_info<span class=\"token token-operator punctuation\">-</span>value<span class=\"token punctuation\">.</span>\n          <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n          <span class=\"token keyword\">APPEND</span> gs_session_list <span class=\"token keyword\">TO</span> gt_sessions_user<span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n    <span class=\"token eol-comment comment\">\" last step is the bdc index - no matter what the order of the dynpro numbers or if there are skips between the numbers, the BDC is always 01, 02, 03, 04... counting number so we need sy-tabix</span>\n    <span class=\"token keyword\">IF</span> gt_sessions_user <span class=\"token keyword\">IS</span> <span class=\"token keyword\">NOT</span> <span class=\"token keyword\">INITIAL</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" check if there is anything for the user sessions, or if the index found</span>\n      <span class=\"token keyword\">SORT</span> gt_sessions_user <span class=\"token keyword\">BY</span> session_hdl <span class=\"token keyword\">ASCENDING</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" this is how they are shown in the gui, so since we are using bdc we also have to do this</span>\n      <span class=\"token keyword\">LOOP</span> <span class=\"token keyword\">AT</span> gt_sessions_user <span class=\"token keyword\">INTO</span> gs_sessions_user<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" loop at all open sessions for the USER within the correct logon ID</span>\n        gv_modus_num   <span class=\"token operator\">=</span> gs_sessions_user<span class=\"token token-operator punctuation\">-</span>session_hdl<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" current session</span>\n        <span class=\"token eol-comment comment\">\" Kill only the session from the table that matches the index of the modus found</span>\n        <span class=\"token keyword\">IF</span> gv_modus_num <span class=\"token operator\">=</span> gv_modus_num_found<span class=\"token punctuation\">.</span>\n          gv_modus_index_char <span class=\"token operator\">=</span> sy<span class=\"token token-operator punctuation\">-</span>tabix<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" then the index of the modus for this user is sy-tabix - we need the index, rather than the actual number of the session for the BDC</span>\n          <span class=\"token keyword\">CLEAR</span> gv_modus_string<span class=\"token punctuation\">.</span>\n          <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'MODUS-MTCODE(0'</span> gv_modus_index_char <span class=\"token string\">')'</span> <span class=\"token keyword\">INTO</span> gv_modus_string<span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" build the bdcfield name using the index of where in the user's list the</span>\n        <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n\n      <span class=\"token keyword\">IF</span> gv_modus_index_char <span class=\"token keyword\">EQ</span> <span class=\"token string\">'0'</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" Then we have the false server and we have to continue ahead</span>\n        <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n\n      <span class=\"token eol-comment comment\">\" First ensure that sm04 is called and set to the sessions view</span>\n      <span class=\"token keyword\">CLEAR</span> bdcdata[]<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=SESSIONS'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" call transaction SM04, sync (S), no screens unless debugger (P)</span>\n      <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token string\">'SM04'</span>\n              <span class=\"token keyword\">USING</span> bdcdata\n              <span class=\"token keyword\">MODE</span> <span class=\"token string\">'P'</span>\n              <span class=\"token keyword\">UPDATE</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">.</span>\n\n      <span class=\"token eol-comment comment\">\" Now use bdc to end the session with that session id</span>\n      <span class=\"token keyword\">CLEAR</span> bdcdata[]<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;OL0'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSKBH'</span> <span class=\"token string\">'0800'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'GT_FIELD_LIST-SELTEXT(01)'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=WLSE'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'GT_FIELD_LIST-MARK(01)'</span> <span class=\"token string\">'X'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSKBH                                0810SUB810'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSKBH'</span> <span class=\"token string\">'0800'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'GT_FIELD_LIST-SELTEXT(01)'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=CONT'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSKBH                                0810SUB810'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/03'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=PS 63'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'02/76'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;IC1'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'02/76'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;ILT'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPLSSEL'</span> <span class=\"token string\">'1104'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=CRET'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_SUBSCR'</span> <span class=\"token string\">'SAPLSSEL                                1105%_SUBSCREEN_FREESEL'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'%%DYN001-LOW'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'%%DYN001-LOW'</span> gv_ssi_session_id<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/15'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;IC1'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'RSM04000_ALV_NEW'</span> <span class=\"token string\">'2000'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> gv_modus_string<span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=DEL'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">PERFORM</span> bdcdaten <span class=\"token keyword\">USING</span><span class=\"token punctuation\">:</span>\n        <span class=\"token string\">'X'</span> <span class=\"token string\">'SAPMSSY0'</span> <span class=\"token string\">'0120'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_CURSOR'</span> <span class=\"token string\">'04/15'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token string\">' '</span> <span class=\"token string\">'BDC_OKCODE'</span> <span class=\"token string\">'=&amp;F15'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token eol-comment comment\">\" call transaction SM04, sync (S), no screens unless debugger (P)</span>\n      <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token string\">'SM04'</span>\n              <span class=\"token keyword\">USING</span> bdcdata\n              <span class=\"token keyword\">MODE</span> <span class=\"token string\">'P'</span>\n              <span class=\"token keyword\">UPDATE</span> <span class=\"token string\">'S'</span><span class=\"token punctuation\">.</span>\n\n      <span class=\"token eol-comment comment\">\" proper logging. times, order number, and transaction added as well as</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'User session from user '</span><span class=\"token punctuation\">,</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname<span class=\"token punctuation\">,</span> <span class=\"token string\">'with session number'</span><span class=\"token punctuation\">,</span> gv_modus_index_char<span class=\"token punctuation\">,</span> <span class=\"token string\">'was deleted.'</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'System Time (sy-uzeit): '</span><span class=\"token punctuation\">,</span> gv_uzeit<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'Object Lock Time Length:'</span><span class=\"token punctuation\">,</span> gs_enq<span class=\"token token-operator punctuation\">-</span>gttime<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'Lock Time: '</span><span class=\"token punctuation\">,</span> gv_time_dif_sperr<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'Order: '</span><span class=\"token punctuation\">,</span> gv_aufnr_string<span class=\"token punctuation\">,</span> <span class=\"token string\">',Transaction'</span><span class=\"token punctuation\">,</span> gv_tcode<span class=\"token punctuation\">.</span>\n\n      <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'SO_STRUCT_TO_CHAR'</span>\n        <span class=\"token keyword\">EXPORTING</span>\n          ip_struct <span class=\"token operator\">=</span> gs_enq\n        <span class=\"token keyword\">IMPORTING</span>\n          ep_string <span class=\"token operator\">=</span> gv_string<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">CONDENSE</span> gv_string<span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">WRITE</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">/</span> <span class=\"token string\">'Lock object entry contains:'</span><span class=\"token punctuation\">,</span> gv_string<span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ELSEIF</span> gv_time_dif_sperr <span class=\"token operator\">></span> <span class=\"token string\">'001000'</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" Second warning message after 10 minutes</span>\n    <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'You are locking'</span> gv_aufnr_string <span class=\"token string\">' in TC '</span> gv_tcode <span class=\"token string\">' still. Please save and leave the transaction, otherwise your session will be ended in 5 min. Thank you!'</span> <span class=\"token keyword\">INTO</span> gv_message <span class=\"token keyword\">SEPARATED</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">space</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'TH_POPUP'</span>\n      <span class=\"token keyword\">EXPORTING</span>\n        <span class=\"token keyword\">client</span>         <span class=\"token operator\">=</span> sy<span class=\"token token-operator punctuation\">-</span>mandt\n        <span class=\"token keyword\">user</span>           <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname\n        <span class=\"token keyword\">message</span>        <span class=\"token operator\">=</span> gv_message\n      <span class=\"token keyword\">EXCEPTIONS</span>\n        user_not_found <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">OTHERS</span>         <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">IF</span> sy<span class=\"token token-operator punctuation\">-</span>subrc <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ELSEIF</span> gv_time_dif_sperr <span class=\"token operator\">></span> <span class=\"token string\">'000500'</span><span class=\"token punctuation\">.</span> <span class=\"token eol-comment comment\">\" First warning message after 5 minutes</span>\n    <span class=\"token keyword\">CONCATENATE</span> <span class=\"token string\">'You are locking'</span> gv_aufnr_string <span class=\"token string\">'in TC'</span> gv_tcode <span class=\"token string\">' for >5min. Please save and leave the transaction.'</span> <span class=\"token keyword\">INTO</span> gv_message <span class=\"token keyword\">SEPARATED</span> <span class=\"token keyword\">BY</span> <span class=\"token keyword\">space</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">CALL</span> <span class=\"token keyword\">FUNCTION</span> <span class=\"token string\">'TH_POPUP'</span>\n      <span class=\"token keyword\">EXPORTING</span>\n        <span class=\"token keyword\">client</span>         <span class=\"token operator\">=</span> sy<span class=\"token token-operator punctuation\">-</span>mandt\n        <span class=\"token keyword\">user</span>           <span class=\"token operator\">=</span> gs_enq<span class=\"token token-operator punctuation\">-</span>guname\n        <span class=\"token keyword\">message</span>        <span class=\"token operator\">=</span> gv_message\n      <span class=\"token keyword\">EXCEPTIONS</span>\n        user_not_found <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">OTHERS</span>         <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">IF</span> sy<span class=\"token token-operator punctuation\">-</span>subrc <span class=\"token operator\">&lt;></span> <span class=\"token number\">0</span><span class=\"token punctuation\">.</span>\n      <span class=\"token keyword\">CONTINUE</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">ENDLOOP</span><span class=\"token punctuation\">.</span>\n\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token comment\">*&amp;      Form  BDCDATEN</span>\n<span class=\"token comment\">*&amp;---------------------------------------------------------------------*</span>\n<span class=\"token keyword\">FORM</span> bdcdaten <span class=\"token keyword\">USING</span> start fnam fval<span class=\"token punctuation\">.</span>\n\n  <span class=\"token keyword\">CLEAR</span> bdcdata<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">IF</span> start <span class=\"token operator\">=</span> <span class=\"token string\">'X'</span><span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>dynbegin <span class=\"token operator\">=</span> start<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>program  <span class=\"token operator\">=</span> fnam<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>dynpro   <span class=\"token operator\">=</span> fval<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ELSE</span><span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>fnam <span class=\"token operator\">=</span> fnam<span class=\"token punctuation\">.</span>\n    bdcdata<span class=\"token token-operator punctuation\">-</span>fval <span class=\"token operator\">=</span> fval<span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">ENDIF</span><span class=\"token punctuation\">.</span>\n  <span class=\"token keyword\">APPEND</span> bdcdata<span class=\"token punctuation\">.</span>\n\n<span class=\"token keyword\">ENDFORM</span><span class=\"token punctuation\">.</span>                               <span class=\"token eol-comment comment\">\" BDCDATEN</span></code></pre>\n      </div>\n<p>Whew. That‚Äôs about it for this one, hope you enjoyed!</p>","frontmatter":{"title":"Warn SAP Users of Locked Objects Then Kill Their Session","date":"May 09, 2018","draft":false}}},"pageContext":{"slug":"/warn-sap-users-of-locked-objects-then-kill-their-session/","prev":{"fields":{"slug":"/detailed-look-at-bdc-in-abap/"},"frontmatter":{"date":"24 January, 2018","title":"A Detailed Look at ABAP's BDC Method","draft":true,"link":"https://chrisfrew.in/detailed-look-at-bdc-in-abap/","relativeLink":"/detailed-look-at-bdc-in-abap/"}},"next":{"fields":{"slug":"/calculating-activity-amounts-for-process-and-production-orders-with-sap-abap/"},"frontmatter":{"date":"03 January, 2018","title":"Calculating Activity Amounts for Production and Process Orders with SAP ABAP","draft":false,"link":"https://chrisfrew.in/calculating-activity-amounts-for-process-and-production-orders-with-sap-abap/","relativeLink":"/calculating-activity-amounts-for-process-and-production-orders-with-sap-abap/"}}}}