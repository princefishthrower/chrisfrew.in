{"data":{"site":{"siteMetadata":{"title":"Chris Frewin's Full Stack, Web Development, ABAP, SAPUI5, Blockchain, Machine Learning, & Natural Language Processing Blog.","author":"Chris Frewin"}},"markdownRemark":{"id":"1b112303-65e9-5ef8-9440-2a0590a791dc","excerpt":"Background and Overview of this Technologically Amazing Accomplishment After a bit of thinking about my automation project, I settled on aâ€¦","html":"<h2>Background and Overview of this Technologically Amazing Accomplishment</h2>\n<p>After a bit of thinking about my automation project, I settled on a single subdomain (at least for now), fittedly named <a href=\"https://webhooks.chrisfrew.in\">https://webhooks.chrisfrew.in</a>. (Go on, you can try clicking on it). However, if youâ€™re not an authorized party (which I check via a <em>secret key</em>) youâ€™ll just be redirected to the plain olâ€™ <a href=\"https://chrisfrew.in\">https://chrisfrew.in</a> - yeah I know, what a crappy blog.</p>\n<p>If any of this stuff sounds cool, or perhaps more importantly, sounds like a foreign language, then câ€™mon in and dive in - weâ€™ll get into the technical details and all steps of how all of this can be set up.</p>\n<p>Remember, all this stuff is open source too. The repository for the monitor is here: <a href=\"https://github.com/frewinchristopher/chrisfrew.in-productions-github-bitbucket-monitor\">https://github.com/frewinchristopher/chrisfrew.in-productions-github-bitbucket-monitor</a></p>\n<p>(The full code is also posted at the bottom of this post.)</p>\n<h2>Setting Up a Catch-All webhooks subdomain</h2>\n<p>So <a href=\"chrisfrew.in\">chrisfrew.in</a> is registered on Namecheap. We have to just setup two A Records, both for webhooks www.webhooks. It looks like this:</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 21.066907775768534%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAmklEQVQY03WPTQrEIAyF3XiMgmdw0WMWl1M8Y+mi/qO+MY4tDsMEQl6S50dkuRSEGGG9h2+11oqUEihe+w7GGKSUOM+zz0rzk+fWPoTeUxpjwHLOiANA0RfWdq2U6kAhBI7j+AJSkqa3ZfTO+Q/QTxeSyTVNsW1bBy7L8hdI3nv2XOja2VRpUaYLtdbgnGNd198vD6CdgNd14Q3/UyCOC/OIXwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Namecheap configuration\"\n        title=\"\"\n        src=\"/static/31f8d6e653672fd7d4238a57a2f72a1b/a408b/namecheap_config.png\"\n        srcset=\"/static/31f8d6e653672fd7d4238a57a2f72a1b/4eabf/namecheap_config.png 148w,\n/static/31f8d6e653672fd7d4238a57a2f72a1b/5a375/namecheap_config.png 295w,\n/static/31f8d6e653672fd7d4238a57a2f72a1b/a408b/namecheap_config.png 590w,\n/static/31f8d6e653672fd7d4238a57a2f72a1b/9a0cc/namecheap_config.png 885w,\n/static/31f8d6e653672fd7d4238a57a2f72a1b/56a50/namecheap_config.png 1106w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  </p>\n<h2>Listing on Webhooks subdomain - POST and â€˜allâ€™</h2>\n<p>So first off, we want our express app to only do special things on a post to the root (in this case, because I run NGINX, we are already in the webhooks.chrisfrew.in namespace here) - otherwise we redirect to <a href=\"https://chrisfrew.in\">https://chrisfrew.in</a></p>\n<p>Notice that even when ARE POSTed to, we still verify the signature of the request, otherwise just like the <code class=\"language-text\">all(&#39;*&#39;)</code>, we redirect (301) the traffic to chrisfrew.in.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">verifySignature</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">determineWebhook</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// authentic source</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication successful; processing data:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Someone else calling</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication failed; redirecting them to https://chrisfrew.in'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">301</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://chrisfrew.in/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Redirect to domain root</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Someone else calling</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication failed; redirecting them to https://chrisfrew.in'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">301</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://chrisfrew.in/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Redirect to domain root</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Only webhook requests allowed at this address</span></code></pre>\n      </div>\n<h2>Determine What type of Webhook</h2>\n<p>Right now I only process GitHub and Bitbucket Webhooks. Itâ€™s rudimentary, and itâ€™s not even finished, but it works for GitHub:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">determineWebhook</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> sStatus<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// GitHub</span>\n    sStatus <span class=\"token operator\">=</span> <span class=\"token string\">\"New head commit in \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">\" (\"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>url <span class=\"token operator\">+</span> <span class=\"token string\">\"): \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>committer<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>added<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span> <span class=\"token string\">\" added \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>added<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files, \"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>modified<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span>  <span class=\"token string\">\" modified \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>modified<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files, and\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>removed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span>  <span class=\"token string\">\" removed \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>removed<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files.\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>sStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Attempting to pull from this repository...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token function\">pull</span><span class=\"token punctuation\">(</span>oRepositoryPathValuePairs<span class=\"token punctuation\">[</span>oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//twitterBotUtils.postStatus(sStatus);</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>actor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Bitbucket</span>\n    \n    <span class=\"token comment\">//twitterBotUtils.postStatus(sStatus);</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// some other webhook (there are no others yet)</span>\n    \n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<h2>GitHub Integration</h2>\n<p>With our subdomain set up and our express server serving there, we can start processing requests for <code class=\"language-text\">webhooks.chrisfrew.in</code>. The important thing here is to validate requests. Imagine what could happen without validation, (if I eventualy do hook this up to my twitter bot to post every time a repository is updated) just anyone could send random github-ish looking json data to <code class=\"language-text\">webhooks.chrisfrew.in</code>, and my server would take action, even when its not coming from a validate That would be really annoying, and plus, it would make me seem <em>way</em> more productive than I am with my repositories. ðŸ˜‚ðŸ˜‚ðŸ˜‚ So yeah, validation is an important step. </p>\n<p>GitHubâ€™s way of doing authentication for webhooks is to take the content of the payload, concatenate that with the secret key, and then hash it. You then do the same on your server, since you yourself also know the secret key, and if the hashes match, violÃ¡! You know itâ€™s coming from GitHub. We accomplish this in Nodejs in a function called <code class=\"language-text\">verifySignature</code> like so:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Verification function to check if it is actually GitHub who is POSTing here</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">verifySignature</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GitHub-Hookshot'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Compare their hmac signature to our hmac signature</span>\n  <span class=\"token comment\">// (hmac = hash-based message authentication code)</span>\n  <span class=\"token keyword\">const</span> sExternalSignature <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-hub-signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> oData <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> sSecret <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">WEBHOOK_SECRET</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">const</span> sInternalSignature <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`sha1=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHmac</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha1'</span><span class=\"token punctuation\">,</span> sSecret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">timingSafeEqual</span><span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>sExternalSignature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>sInternalSignature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<h2>GitHub Integration</h2>\n<p>So, we know - then on the production server we want to naturally pull this newest code from the remote? For that, there is the NPM package <code class=\"language-text\">simple-git</code> <a href=\"https://github.com/steveukx/git-js#readme\">https://github.com/steveukx/git-js#readme</a>.</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">pull</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  git<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>update <span class=\"token operator\">&amp;&amp;</span> update<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">.</span>changes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// there is indeed an update found on the remote</span>\n        <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"This is an app templated by create-react-app; We need to issue 'npm run build' to build new source...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"commit your changes or stash them\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Changes need to be stashed; stashing automatically...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token function\">stashAndPull</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span><span class=\"token comment\">// TODO: more error cases? ...</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">stashAndPull</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  git<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stash</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Stash succesfull, attempting to pull again...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">pull</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<h2>Build Integration</h2>\n<p>So, I thought it was nice that we could detect pushes to the repository and then . But, with my create-react-apps, could I also build the source. If you were eagle-eyed, you may have seen that sneaky <code class=\"language-text\">build()</code> function. That function looks like this:</p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">build</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">'npm run build'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cwd<span class=\"token punctuation\">:</span> <span class=\"token string\">'../charge-keyboard.com'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Build command successfully sent. The site should be live with the newly commited changes incorporated.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>The <em>very</em> cool thing here, at least I think, is that since I run my <code class=\"language-text\">index.js</code> servers with <code class=\"language-text\">forever</code>, when the source is built, whatever <code class=\"language-text\">index.js</code> is serving is updated, without affecting the runtime of <code class=\"language-text\">index.js</code> itself! So, I am nearly approaching a fully integrated build system that was all custom built. ðŸ˜„</p>\n<h2>Other Fun stuff</h2>\n<p>You know how when your <code class=\"language-text\">npm start</code> wont work, only because of a missing module? Iâ€™ve always been like, well, the <em>single</em> solution here <em>is to just install the friggen module</em> Well, thanks to stdout, we can try to read those missing modules, install it, and try <code class=\"language-text\">npm start</code> again. This is something I am working on.</p>\n<p>Youâ€™ll notice a lot of the code is parsing <code class=\"language-text\">stdout</code> as strings - I realize out to an infinite time scale, this isnâ€™t a most robust way of checking error messages, so Iâ€™m working towards parsing the actual errors codes from Nodejs and reacting from those, instead of the error text itself.</p>\n<p>You may have also noticed the function messageHub for nearly every logging type message. Indeed, we do log to the console, but I built this hub-type function so we could add more ways of messaging, one of them is through a Slack bot, which I show how to do in <a href=\"https://chrisfrew.in/fully-automating-chrisfrew-in-productions-part-4-of-building-a-slack-bot/\">Part 4</a></p>\n<p>Youâ€™ll see I have logging util and twitter util functions commented out - they are coming - all with good time!</p>\n<h2>To Do List</h2>\n<p>Iâ€™ve still got to add all my other sites to the monitor - this is just a matter adding to that key:value that the server monitors - see <code class=\"language-text\">oRepositoryPathValuePairs</code> in the code below for what I am talking about.</p>\n<p>What will be really cool is for the GitHub monitor to update itself when it sees that itâ€™s remote - yes, this is like some Terminator-level crap. This will be a special case, because in order for a flawless execution of the monitor server itself, it would have to spawn a child process of itself, then update its code, then start itself, finally killing the child process of its older version.</p>\n<h2>Full code</h2>\n<p><code class=\"language-text\">index.js</code></p>\n<div class=\"gatsby-highlight\">\n      <pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">'use strict'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// strict</span>\n\n<span class=\"token comment\">// external library requires</span>\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> crypto <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crypto'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> twitterBotUtils <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../chrisfrew.in-productions-shared-functions/utils/twitterBotUtils.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> simpleGit <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'simple-git'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> git <span class=\"token operator\">=</span> <span class=\"token function\">simpleGit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axios'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> exec <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'child_process'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>exec<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// fixed port on dell</span>\n<span class=\"token keyword\">const</span> iPort <span class=\"token operator\">=</span> <span class=\"token number\">8087</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> oRepositoryPathValuePairs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"charge-keyboard-splash-page\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"../charge-keyboard.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"chrisfrew.in-productions-github-bitbucket-monitor\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// super meta - will restart itself</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// The GitHub webhook MUST be configured to be sent as \"application/json\"</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Verification function to check if it is actually GitHub who is POSTing here</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">verifySignature</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'user-agent'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GitHub-Hookshot'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Compare their hmac signature to our hmac signature</span>\n  <span class=\"token comment\">// (hmac = hash-based message authentication code)</span>\n  <span class=\"token keyword\">const</span> sExternalSignature <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-hub-signature'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> oData <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> sSecret <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">WEBHOOK_SECRET</span><span class=\"token punctuation\">;</span> \n  <span class=\"token keyword\">const</span> sInternalSignature <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`sha1=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>crypto<span class=\"token punctuation\">.</span><span class=\"token function\">createHmac</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sha1'</span><span class=\"token punctuation\">,</span> sSecret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">digest</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hex'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> crypto<span class=\"token punctuation\">.</span><span class=\"token function\">timingSafeEqual</span><span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>sExternalSignature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token keyword\">from</span><span class=\"token punctuation\">(</span>sInternalSignature<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">determineWebhook</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> sStatus<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>sender<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// GitHub</span>\n    sStatus <span class=\"token operator\">=</span> <span class=\"token string\">\"New head commit in \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">\" (\"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>url <span class=\"token operator\">+</span> <span class=\"token string\">\"): \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>committer<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>added<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span> <span class=\"token string\">\" added \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>added<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files, \"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>modified<span class=\"token punctuation\">)</span>  <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span>  <span class=\"token string\">\" modified \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>modified<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files, and\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>removed<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      sStatus <span class=\"token operator\">=</span> sStatus <span class=\"token operator\">+</span>  <span class=\"token string\">\" removed \"</span> <span class=\"token operator\">+</span> oData<span class=\"token punctuation\">.</span>head_commit<span class=\"token punctuation\">.</span>removed<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token string\">\" files.\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>sStatus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Attempting to pull from this repository...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token function\">pull</span><span class=\"token punctuation\">(</span>oRepositoryPathValuePairs<span class=\"token punctuation\">[</span>oData<span class=\"token punctuation\">.</span>repository<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//twitterBotUtils.postStatus(sStatus);</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oData<span class=\"token punctuation\">.</span>actor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Bitbucket</span>\n    \n    <span class=\"token comment\">//twitterBotUtils.postStatus(sStatus);</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// some other webhook (there are no others yet)</span>\n    \n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">pull</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  git<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>update <span class=\"token operator\">&amp;&amp;</span> update<span class=\"token punctuation\">.</span>summary<span class=\"token punctuation\">.</span>changes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// there is indeed an update found on the remote</span>\n        <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"This is an app templated by create-react-app; We need to issue 'npm run build' to build new source...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"commit your changes or stash them\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Changes need to be stashed; stashing automatically...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n         <span class=\"token function\">stashAndPull</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span><span class=\"token comment\">// TODO: more error cases? ...</span>\n     <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">stashAndPull</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  git<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stash</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Stash succesfull, attempting to pull again...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">pull</span><span class=\"token punctuation\">(</span>sRootRepositoryDirectory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">build</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string\">'npm run build'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cwd<span class=\"token punctuation\">:</span> <span class=\"token string\">'../charge-keyboard.com'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> stdout<span class=\"token punctuation\">,</span> stderr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span>stderr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token function\">messageHub</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Build command successfully sent. The site should be live with the newly commited changes incorporated.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">messageHub</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// all the ways of messaging combined into one messaging \"hub\"</span>\n  <span class=\"token comment\">//twitterBotUtils.postStatus(sMessage); // // TODO: : make live!!!</span>\n  <span class=\"token comment\">//loggingUtils.logMessage(sMessage): // TODO: also make live!!!</span>\n  <span class=\"token function\">slackBotWebHook</span><span class=\"token punctuation\">(</span>sMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>sMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">slackBotWebHook</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sMessage<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  axios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">CHRISFREW_IN_SLACK_BOT_WEBHOOK_URL</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    text<span class=\"token punctuation\">:</span> sMessage\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">verifySignature</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">determineWebhook</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// authentic source</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication successful; processing data:'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Someone else calling</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication failed; redirecting them to https://chrisfrew.in'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">301</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://chrisfrew.in/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Redirect to domain root</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token string\">'*'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Someone else calling</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Authentication failed; redirecting them to https://chrisfrew.in'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">redirect</span><span class=\"token punctuation\">(</span><span class=\"token number\">301</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'https://chrisfrew.in/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Redirect to domain root</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Only webhook requests allowed at this address</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>iPort<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Webhook service running at http://localhost:'</span> <span class=\"token operator\">+</span> iPort<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n      </div>\n<p>And again, donâ€™t forget the updated code is all available on GitHub: <a href=\"https://github.com/frewinchristopher/chrisfrew.in-productions-github-bitbucket-monitor\">https://github.com/frewinchristopher/chrisfrew.in-productions-github-bitbucket-monitor</a></p>\n<p>Cheers! ðŸº</p>","frontmatter":{"title":"Fully Automating Chrisfrew.in Productions - Part 3 of ??? - Building a GitHub Webhook Monitor","date":"July 20, 2018","draft":false}}},"pageContext":{"slug":"/fully-automating-chrisfrew-in-productions-part-3-of-github-webhook-monitor/","prev":{"fields":{"slug":"/fully-automating-chrisfrew-in-productions-part-2-of-building-a-node-js-server-monitor/"},"frontmatter":{"date":"11 May, 2018","title":"Fully Automating Chrisfrew.in Productions - Part 2 of ??? - Building a Node.js Server Monitor","draft":false,"link":"https://chrisfrew.in/fully-automating-chrisfrew-in-productions-part-2-of-building-a-node-js-server-monitor/","relativeLink":"/fully-automating-chrisfrew-in-productions-part-2-of-building-a-node-js-server-monitor/"}},"next":{"fields":{"slug":"/hot-linking-to-lines-in-github/"},"frontmatter":{"date":"19 December, 2017","title":"How to Link to Lines of Code in a Github Repository!","draft":false,"link":"https://chrisfrew.in/hot-linking-to-lines-in-github/","relativeLink":"/hot-linking-to-lines-in-github/"}}}}